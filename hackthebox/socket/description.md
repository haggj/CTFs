# Stocker

## Analysis

- nmap scan reveals open ports `80`, `22` and `5789`
  - ssh version `OpenSSH 8.9p1 Ubuntu 3ubuntu0.1`
  - webserver running `Apache httpd 2.4.52`
    - website allows to create QR codes which contain custom text
    - Seems to be a python `flask` server
    - it also is possible to upload images, which then will be scanned to extract the text from the QR code
    - tested payloads for LFI and RCE, but did not work
  - open port `5789` is a websocket server
      - connected to it via `python3 -m websocket qrcode.htb:5789`
      - websocket uses JSON data

- directory enumeration
  - `/report` allows to send a report to the team
  - `/reader` reads a given QR code


## Solution

### User flag

The websocket connection is vulnerable to a SQL injection:
```bash
# Valid requests
{"version": "0.0.2"} # ok
{"version": "0.0.3"} # does not exist
# SQLi request
{"version": "0.0.3\" or 1=1; --"}
```

To exploit this via sqlmap, a proxy is needed (see ``sqlmap_server.py``).
Then use the following command to exploit the vulnerability:
```
sqlmap -u "http://localhost:8081/?data=0.0.1" --prefix'"'
```

- This dumps a user table containing a user `admin` with a password hash.
Decode MD5 hash `0c090c365fa0559b151a43e0fea39710` with hashcat yields password `denjanjade122566`.
Can not login with this password, because the username is probably not `admin`.
- The database dumps also show that the administrator is named `Thomas Keller`. 
Used tool `username-anarchy` to get potential usernames.#
- Used `hydra` with usernames generated by `username-anarchy` to get ssh access.
Valid credentials are `tkeller/denjanjade122566`


### System flag
- User `tkeller` can run `/usr/local/sbin/build-installer.sh` as root (`sudo -l`)
- This script is a wrapper for `pyinstaller` and can be used to create a binary from a python script.
- The script checks if the input file ends with `.spec` and if it does, it is executed with `pyinstaller`
  (`.spec` files contain python code which is executed by `pyinstaller`).
- Thus, we can create a malicious `sh.py.spec` file which provides a shell:
```python3
import pty
pty.spawn("/bin/sh")
```
- Then, we can run our malicous spec file with the following command to obtain a root shell:
```
sudo /usr/local/sbin/build-installer.sh build sh.py.spec
```